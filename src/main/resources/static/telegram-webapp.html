<!-- src/main/resources/static/telegram-webapp.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Musoren - –í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }

        .logo {
            font-size: 48px;
            margin-bottom: 20px;
            color: #0088cc;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.5;
        }

        .btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .btn:hover {
            background: #006699;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn i {
            font-size: 24px;
        }

        .requirements {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
        }

        .requirements h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .requirements ul {
            list-style: none;
            padding-left: 0;
        }

        .requirements li {
            padding: 8px 0;
            color: #555;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .requirements li:before {
            content: "‚úÖ";
            font-size: 14px;
        }

        .loading {
            display: none;
            margin: 20px 0;
        }

        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .instructions {
            font-size: 14px;
            color: #666;
            margin-top: 15px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="logo">üóëÔ∏è</div>
    <h1>Musoren</h1>
    <p class="subtitle">–°–µ—Ä–≤–∏—Å –≤—ã–≤–æ–∑–∞ –º—É—Å–æ—Ä–∞</p>

    <div id="login-section">
        <p class="instructions">
            –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ –≤—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —Å–≤—è–∑–∏ —Å –∫—É—Ä—å–µ—Ä–æ–º.
        </p>

        <button id="login-btn" class="btn">
            <span>üîë</span>
            <span id="btn-text">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</span>
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</p>
        </div>

        <div class="result" id="result"></div>
    </div>

    <div class="requirements">
        <h3>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:</h3>
        <ul>
            <li>–†–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (+7XXXXXXXXXX)</li>
            <li>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç Telegram</li>
            <li>–î–æ—Å—Ç—É–ø –∫ –Ω–æ–º–µ—Ä—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</li>
        </ul>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;

    // –†–∞—Å—à–∏—Ä—è–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
    tg.expand();

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    tg.MainButton.setText("–í–æ–π—Ç–∏");
    tg.MainButton.onClick(handleLogin);
    tg.MainButton.show();

    // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –ø–æ –Ω–∞—à–µ–π –∫–Ω–æ–ø–∫–µ
    document.getElementById('login-btn').addEventListener('click', handleLogin);

    async function handleLogin() {
        const btn = document.getElementById('login-btn');
        const btnText = document.getElementById('btn-text');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        btn.disabled = true;
        btnText.textContent = "–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞...";
        loading.style.display = 'block';
        result.style.display = 'none';

        try {
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–Ω—Ç–∞–∫—Ç (–Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞)
            tg.requestContact(async (contactGranted) => {
                if (!contactGranted) {
                    showResult('–î–ª—è –≤—Ö–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞.', 'error');
                    resetButton(btn, btnText, loading);
                    return;
                }

                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
                const userData = tg.initDataUnsafe.user;

                if (!userData || !userData.phone_number) {
                    showResult('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
                    resetButton(btn, btnText, loading);
                    return;
                }

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                btnText.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...";

                // –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const authRequest = {
                    id: userData.id,
                    first_name: userData.first_name,
                    last_name: userData.last_name || '',
                    username: userData.username || '',
                    photo_url: userData.photo_url || '',
                    auth_date: tg.initDataUnsafe.auth_date,
                    hash: tg.initDataUnsafe.hash,
                    phone_number: userData.phone_number,
                    init_data: tg.initData
                };

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä
                const response = await sendAuthRequest(authRequest);

                if (response.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage Web App
                    if (response.data?.token) {
                        localStorage.setItem('jwt_token', response.data.token);
                        localStorage.setItem('user_data', JSON.stringify(response.data.user));
                    }

                    showResult('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –°–µ–π—á–∞—Å –≤—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã...', 'success');

                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É Telegram
                    tg.MainButton.setText("–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç");
                    tg.MainButton.onClick(() => {
                        // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–∞–π—Ç–∞
                        window.location.href = 'https://–≤–∞—à-—Å–∞–π—Ç.com';
                    });

                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => {
                        tg.close();
                    }, 3000);

                } else {
                    showResult(`‚ùå –û—à–∏–±–∫–∞: ${response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                    resetButton(btn, btnText, loading);
                }
            });

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
            showResult('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.', 'error');
            resetButton(btn, btnText, loading);
        }
    }

    async function sendAuthRequest(authData) {
        try {
            const response = await fetch('/api/auth/telegram/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(authData)
            });

            return await response.json();

        } catch (error) {
            throw new Error('Network error: ' + error.message);
        }
    }

    function showResult(message, type) {
        const result = document.getElementById('result');
        result.textContent = message;
        result.className = `result ${type}`;
        result.style.display = 'block';
    }

    function resetButton(btn, btnText, loading) {
        btn.disabled = false;
        btnText.textContent = "–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞";
        loading.style.display = 'none';
    }

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    tg.showPopup({
        title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Musoren!',
        message: '–î–ª—è –≤—Ö–æ–¥–∞ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Å–≤—è–∑–∏ —Å –∫—É—Ä—å–µ—Ä–æ–º.',
        buttons: [{ id: 'ok', type: 'default', text: '–ü–æ–Ω—è—Ç–Ω–æ' }]
    });
</script>
</body>
</html>
