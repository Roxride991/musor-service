# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ 403

## –ü—Ä–æ–±–ª–µ–º–∞

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞ –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–∑–∞–∫–∞–∑—ã, –ø–æ–¥–ø–∏—Å–∫–∏, –∑–æ–Ω—ã) –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫—É 403 Forbidden.

## –ü—Ä–∏—á–∏–Ω–∞

Spring Security —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤. –ï—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-User-Id` –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, `HeaderAuthenticationFilter` –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –∏ Spring Security –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å.

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ HeaderAuthenticationFilter

–¢–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä –ª–æ–≥–∏—Ä—É–µ—Ç:
- –ö–∞–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è
- –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-User-Id`
- –ù–∞–π–¥–µ–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ë–î
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

**–§–∞–π–ª:** `src/main/java/com/example/core/security/HeaderAuthenticationFilter.java`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `@Slf4j` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 2. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ SecurityConfig

–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞:
- **401 Unauthorized** - –∫–æ–≥–¥–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-User-Id` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
- **403 Forbidden** - –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

**–§–∞–π–ª:** `src/main/java/com/example/core/config/SecurityConfig.java`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω `exceptionHandling` —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
- –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å

–í—Å–µ –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-User-Id`:

```
POST /api/orders
Headers:
  Content-Type: application/json
  X-User-Id: 1
Body:
{
    "address": "–û—Ä–µ–Ω–±—É—Ä–≥, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10",
    "pickupTime": "2025-01-20T14:00:00+03:00"
}
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫ X-User-Id –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç?**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ Postman, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω
   - –ó–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

2. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î?**
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ `GET /api/auth/register` –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤ –ë–î

3. **–õ–æ–≥–∏ Backend:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç–µ Backend —Å —É—Ä–æ–≤–Ω–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è DEBUG
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ `HeaderAuthenticationFilter`
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

**–£—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
```
DEBUG HeaderAuthenticationFilter: Request to /api/orders with X-User-Id: 1
DEBUG HeaderAuthenticationFilter: Authentication set for user ID: 1 (role: CLIENT)
```

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω:**
```
DEBUG HeaderAuthenticationFilter: Request to /api/orders with X-User-Id: 999
WARN  HeaderAuthenticationFilter: User with ID 999 not found in database
```

**–ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:**
```
DEBUG HeaderAuthenticationFilter: Request to /api/orders with X-User-Id: null
DEBUG HeaderAuthenticationFilter: X-User-Id header is missing or empty
```

## –û—Ç–≤–µ—Ç—ã API

### 401 Unauthorized (–Ω–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω)

```json
{
    "error": "Unauthorized",
    "message": "–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-User-Id —Å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
}
```

### 403 Forbidden (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤)

```json
{
    "error": "Forbidden",
    "message": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ó–∞–ø—Ä–æ—Å –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞

```
POST /api/orders
Headers:
  Content-Type: application/json
Body:
{
    "address": "–û—Ä–µ–Ω–±—É—Ä–≥, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10",
    "pickupTime": "2025-01-20T14:00:00+03:00"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 401 Unauthorized

### –¢–µ—Å—Ç 2: –ó–∞–ø—Ä–æ—Å —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

```
POST /api/orders
Headers:
  Content-Type: application/json
  X-User-Id: 999
Body:
{
    "address": "–û—Ä–µ–Ω–±—É—Ä–≥, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10",
    "pickupTime": "2025-01-20T14:00:00+03:00"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 401 Unauthorized

### –¢–µ—Å—Ç 3: –ó–∞–ø—Ä–æ—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º

```
POST /api/orders
Headers:
  Content-Type: application/json
  X-User-Id: 1
Body:
{
    "address": "–û—Ä–µ–Ω–±—É—Ä–≥, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10",
    "pickupTime": "2025-01-20T14:00:00+03:00"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 201 Created (–∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω)

## –ü—É–±–ª–∏—á–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–Ω–µ —Ç—Ä–µ–±—É—é—Ç X-User-Id)

- `POST /api/auth/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
- `POST /api/auth/login` - –≤—Ö–æ–¥
- `POST /api/auth/send-code` - –æ—Ç–ø—Ä–∞–≤–∫–∞ OTP
- `GET /api/zones/active` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∑–æ–Ω—ã
- `GET /v3/api-docs/**` - Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `GET /swagger-ui/**` - Swagger UI

## –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ç—Ä–µ–±—É—é—Ç X-User-Id

- `/api/orders/**` - –∑–∞–∫–∞–∑—ã
- `/api/subscriptions/**` - –ø–æ–¥–ø–∏—Å–∫–∏
- `/api/zones` (–∫—Ä–æ–º–µ `/active`) - –∑–æ–Ω—ã
- `/api/users/**` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!** ‚úÖ

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö.







